name: Python Script to export global variables to project json
on:
  workflow_call:
    inputs: 
      source_data: 
        type: string
        required: true
        description: 'Octopus VariableSet Name'
      dest_json:
        type: string
        required: true

jobs:
  build:
    runs-on: [self-hosted, linux]

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Run Python script to pull out the global variables
      shell: python
      run: |
        import json
        import os

        def extract_and_add_variable(source_json, dest_json, variable_names):
            try:
                with open(source_json, 'r') as f:
                    source_data = json.load(f)
            except FileNotFoundError:
                print(f"Source file '{source_json}' not found.")
                return
            except json.JSONDecodeError:
                print(f"Error decoding JSON from source file '{source_json}'.")
                return

            try:
                with open(dest_json, 'r') as f:
                    dest_data = json.load(f)
            except FileNotFoundError:
                print(f"Destination file '{dest_json}' not found. Creating a new file.")
                dest_data = {"Variables": []}
            except json.JSONDecodeError:
                print(f"Error decoding JSON from destination file '{dest_json}'.")
                return

            for variable_name in variable_names:
                existing_variables = [variable["Name"] for variable in dest_data["Variables"]]
                if variable_name in existing_variables:
                    print(f"Variable '{variable_name}' already exists in the destination '{dest_json}' file.")
                else:
                    print(f"Adding the '{variable_name}' property block to the destination '{dest_json}' file")
                    extracted_data = [variable for variable in source_data["Variables"] if variable.get("Name") == variable_name]
                    dest_data["Variables"].extend(extracted_data)

            with open(dest_json, 'w') as f:
                json.dump(dest_data, f, indent=2)

        # Read source data from file
        source_data_file = os.getenv("GITHUB_WORKSPACE") + "/${{ inputs.source_data }}"
        dest_json_file = os.getenv("GITHUB_WORKSPACE") + "/${{ inputs.dest_json }}"

        with open(source_data_file, 'r') as f:
            lines = f.readlines()

        # Process each line in source data
        for line in lines:
            line = line.strip()
            if line:  # Skip empty lines
                source_json, *variable_names = line.split(",")
                source_json = os.getenv("GITHUB_WORKSPACE") + "/" + source_json
                # Call function to extract and add variables to destination JSON
                extract_and_add_variable(source_json, dest_json_file, variable_names)
